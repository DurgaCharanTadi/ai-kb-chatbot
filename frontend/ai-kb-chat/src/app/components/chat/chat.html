<!-- Chat icon shown when panel is closed -->
@if (!isOpen()) {
  <button class="chat-icon" (click)="toggle()" title="Open chat" aria-label="Open chat">
    <!-- white-outline chat bubble, transparent bg -->
    <svg class="chat-icon__svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
      <path d="M4 5a3 3 0 0 1 3-3h10a3 3 0 0 1 3 3v8a3 3 0 0 1-3 3H9l-4 3v-3H7a3 3 0 0 1-3-3z"
            fill="none" stroke="white" stroke-width="2" stroke-linejoin="round"/>
      <circle cx="9"  cy="10" r="1.2" fill="white"/>
      <circle cx="12" cy="10" r="1.2" fill="white"/>
      <circle cx="15" cy="10" r="1.2" fill="white"/>
    </svg>
  </button>
}

<!-- Sliding chat panel (rendered only when open) -->
@if (isOpen()) {
  <div
    class="chat-panel"
    [style.width.px]="width()"
    [style.height.px]="height()"
  >
    <!-- Top edge resize handle (vertical sizing) -->
    <div
      class="resize-handle top"
      title="Drag to resize height"
      aria-label="Resize vertically"
      (mousedown)="onResizeStartTop($event)"
      role="separator"
      aria-orientation="horizontal"
    ></div>

    <!-- Left edge resize handle (horizontal sizing) -->
    <div
      class="resize-handle left"
      title="Drag to resize width"
      aria-label="Resize horizontally"
      (mousedown)="onResizeStartLeft($event)"
      role="separator"
      aria-orientation="vertical"
    ></div>

    <div class="chat-header">
      <span class="title">Support Chat</span>
      <button class="close-button" type="button" (click)="toggle()">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <div class="chat-body" #messageContainer>
      @for (msg of messages(); track $index) {
        <div
          class="message-row"
          [ngClass]="{ 'user': msg.from === 'user', 'assistant': msg.from === 'assistant' }"
        >
          <div class="bubble">
            <p style="white-space: pre-wrap">{{ msg.text }}</p>
            <span class="timestamp">{{ msg.timestamp | date:'shortTime' }}</span>
          </div>
        </div>
      }
    </div>

    <div class="chat-input">
      <input
        type="text"
        [(ngModel)]="newMessage"
        (keyup.enter)="send()"
        placeholder="Type your message…"
        [disabled]="loading()" 
      />
      <button (click)="send()" [disabled]="loading()"> <!-- ✨ CHANGED -->
        @if (loading()) { Sending… } @else { Send }
      </button>
    </div>
  </div>
}
